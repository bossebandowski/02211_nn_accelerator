/*
    This is a minimal C program executed on the FPGA version of Patmos.
    An embedded Hello World program: a blinking LED.

    Additional to the blinking LED we write to the UART '0' and '1' (if available).

    Author: Martin Schoeberl
    Copyright: DTU, BSD License
*/

#include "include/bootable.h"
#include <machine/spm.h>

#define LOOP_DELAY 2

int main() {

	volatile _SPM int *led_ptr  = (volatile _SPM int *) PATMOS_IO_LED;
    volatile _SPM int *axi_eth_ptr = (volatile _SPM int *) 0xf0050000;
    volatile _SPM int *eth_status_ptr = (volatile _SPM int *) 0xf0050000 + 0x07FC;
    volatile _SPM int *eth_length_ptr = (volatile _SPM int *) 0xf0050000 + 0x07F4;
    static char frame[] = {0xff,0xff,0xff,0xff,0xff,0xff,0x54,0xee,0x75,0x01,0x62,0xb6,0x08,0x00,0x45,0x00,0x04,0xfb,0x0a,0xbd,0x00,0x00,0x80,0x11,0x4e,0x13,0xa9,0xfe,0x33,0x24,0xff,0xff,0xff,0xff,0xfd,0x2e,0x13,0x88,0x04,0xe7,0xe9,0x76,0x48,0x65,0x6c,0x6c,0x6f,0x21,0x20,0x49,0x73,0x20,0x69,0x74,0x20,0x6d,0x65,0x20,0x79,0x6f,0x75,0x27,0x72,0x65,0x20,0x6c,0x6f,0x6f,0x6b,0x69,0x6e,0x67,0x20,0x66,0x6f,0x72,0x3f,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x2e,0x37,0x37,0x6f,0x30,0x55,0x40,0x57,0x45,0x53,0x4e,0x57,0x40,0x6d,0x79,0x6f,0x5a,0x3b,0x2c,0x2e,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x3b,0x4e,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x40,0x57,0x2c,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x40,0x57,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x40,0x40,0x40,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x4e,0x6f,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x41,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x40,0x40,0x40,0x6d,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x6d,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x40,0x40,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x3b,0x57,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x40,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x40,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x3a,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x42,0x40,0x40,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x40,0x40,0x57,0x41,0x57,0x40,0x40,0x42,0x37,0x57,0x43,0x44,0x40,0x40,0x32,0x20,0x20,0x53,0x57,0x40,0x57,0x40,0x57,0x40,0x40,0x40,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x40,0x40,0x40,0x57,0x40,0x40,0x40,0x57,0x40,0x20,0x20,0x20,0x20,0x20,0x20,0x2e,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x2c,0x20,0x20,0x20,0x20,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x47,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x2c,0x57,0x40,0x57,0x40,0x40,0x40,0x40,0x40,0x57,0x3b,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x55,0x57,0x40,0x57,0x40,0x57,0x40,0x40,0x40,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x57,0x40,0x54,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x54,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x2c,0x57,0x40,0x40,0x40,0x57,0x40,0x57,0x40,0x57,0x2c,0x20,0x32,0x47,0x70,0x3b,0x37,0x37,0x2c,0x20,0x20,0x20,0x20,0x20,0x20,0x2e,0x43,0x44,0x47,0x44,0x79,0x69,0x20,0x40,0x40,0x57,0x40,0x57,0x40,0x40,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x37,0x57,0x40,0x40,0x40,0x57,0x5a,0x4f,0x40,0x20,0x20,0x20,0x54,0x43,0x40,0x57,0x40,0x57,0x3a,0x2e,0x20,0x20,0x2e,0x2c,0x79,0x44,0x40,0x57,0x6f,0x4b,0x2e,0x20,0x69,0x37,0x63,0x57,0x40,0x40,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x40,0x57,0x40,0x57,0x40,0x49,0x20,0x43,0x20,0x20,0x20,0x20,0x2c,0x37,0x37,0x20,0x2e,0x20,0x3a,0x20,0x20,0x37,0x2e,0x20,0x20,0x2e,0x2c,0x20,0x20,0x20,0x20,0x20,0x20,0x40,0x40,0x57,0x40,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x69,0x40,0x40,0x57,0x40,0x3b,0x20,0x2e,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x3b,0x2e,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x3a,0x4b,0x40,0x57,0x40,0x40,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x41,0x40,0x40,0x57,0x40,0x32,0x37,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x2e,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x57,0x40,0x57,0x57,0x53,0x69,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x2e,0x57,0x40,0x57,0x40,0x57,0x40,0x47,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x2c,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x3a,0x20,0x20,0x20,0x20,0x20,0x2e,0x40,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x79,0x57,0x40,0x40,0x40,0x57,0x40,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x37,0x40,0x40,0x40,0x40,0x57,0x40,0x4b,0x3a,0x20,0x20,0x20,0x20,0x20,0x47,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x41,0x40,0x57,0x40,0x57,0x40,0x20,0x20,0x20,0x20,0x32,0x40,0x57,0x40,0x40,0x47,0x4f,0x42,0x40,0x40,0x57,0x40,0x53,0x20,0x20,0x30,0x6f,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x2e,0x20,0x3a,0x37,0x20,0x20,0x37,0x4e,0x3b,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x37,0x79,0x3a,0x44,0x69,0x2e,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x2e,0x63,0x2c,0x20,0x20,0x20,0x2e,0x20,0x20,0x20,0x20,0x2e,0x2e,0x20,0x20,0x2c,0x30,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x3b,0x37,0x20,0x20,0x20,0x20,0x2e,0x2e,0x20,0x20,0x20,0x20,0x3b,0x69,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x37,0x3b,0x2c,0x20,0x20,0x20,0x20,0x2e,0x3a,0x79,0x37,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x2e,0x2c,0x3a,0x3b,0x3a,0x3a,0x2c,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20};
	int i, j;

	for (;;) {
		//UART_DATA = '1';
		// for (i=LOOP_DELAY; i!=0; --i)
		// 	for (j=LOOP_DELAY; j!=0; --j)
        LEDS = 1;


		//UART_DATA = '0';
		// for (i=LOOP_DELAY; i!=0; --i)
		// 	for (j=LOOP_DELAY; j!=0; --j)
        LEDS = 0;
        LEDS = 1;
        LEDS = 0;
        LEDS = 1;


        for(int i = 0; i < sizeof(frame)-1; i++) {
            while(eth_status_ptr < 0){} // Waiting until EMAC is ready to receive byte
            *axi_eth_ptr = 0x000000ff&frame[i];
            }
        *axi_eth_ptr = 0x40000000|(0x000000ff&frame[sizeof(frame)-1]); // The last byte

	}
}